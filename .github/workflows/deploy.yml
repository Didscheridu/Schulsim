name: Deploy SchulSim

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Inject API Key (Robust)
        env:
          MY_SECRET_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Prüfen, ob das Secret existiert
          if [ -z "$MY_SECRET_KEY" ]; then
            echo "::error::Das Secret GEMINI_API_KEY ist leer oder nicht gefunden! Bitte in den GitHub Settings prüfen."
            exit 1
          fi

          # 2. Prüfen, ob die index.html existiert
          if [ ! -f index.html ]; then
            echo "::error::index.html nicht gefunden! Bist du im richtigen Ordner?"
            exit 1
          fi

          # 3. Python-Script temporär erstellen (vermeidet Syntax-Fehler in YAML)
          cat <<EOF > replace_key.py
          import os

          # Key sicher aus der Umgebung holen
          key = os.environ.get('MY_SECRET_KEY', '')

          try:
              with open('index.html', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              if '__GEMINI_API_KEY__' not in content:
                  print("ACHTUNG: Platzhalter '__GEMINI_API_KEY__' wurde in index.html NICHT gefunden.")
                  # Wir brechen hier nicht ab, falls der Key schon drin steht, aber es ist eine Warnung wert.
              else:
                  # Ersetzen
                  new_content = content.replace('__GEMINI_API_KEY__', key)
                  
                  with open('index.html', 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print("ERFOLG: Der Platzhalter wurde durch den API-Key ersetzt.")

          except Exception as e:
              print(f"Fehler beim Python-Skript: {e}")
              exit(1)
          EOF

          # 4. Script ausführen
          python3 replace_key.py

          # 5. Aufräumen
          rm replace_key.py

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
