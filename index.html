<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SchulSim AI 8.0 (Smart Priority)</title>
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(56, 189, 248, 0.2); } 50% { box-shadow: 0 0 25px rgba(56, 189, 248, 0.5); } }
        .glow { animation: pulse-glow 3s infinite; }

        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .animate-scan { animation: scan 2s linear infinite; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen flex flex-col"></div>

    <script type="text/babel">
        // ==========================================
        // üîê STEALTH KEY KONFIGURATION
        // ==========================================
        const KEY_PART_1 = "AIzaSyCb4nqoilymX4lPn9EOUsZq-"; 
        const KEY_PART_2 = "oKnIISDWAg"; 
        // ==========================================

        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={path} />
            </svg>
        );

        const ICONS = {
            Brain: "M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z",
            Calendar: "M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",
            Presentation: "M2 3h20 M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3 M7 21l5-5 5 5",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            Send: "m22 2-7 20-4-9-9-4Z M22 2 11 13",
            Back: "M19 12H5M12 19l-7-7 7-7",
            Check: "M20 6L9 17l-5-5",
            Key: "M21 2l-2 2m-7.6 7.6l4.4 4.4L22 7l-3-3l-4.4 4.4M2 17l6-6M2 17v4h4",
            Refresh: "M23 4v6h-6M1 20v-6h6",
            Image: "M18 3H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3zM6 8l4 4 4-4 4 4M14 14l-4 4-4-4",
            Sparkles: "m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
        };

        // --- CORE LOGIK ---
        const getKey = () => {
            const assembled = KEY_PART_1 + KEY_PART_2.split('').reverse().join('');
            if (!assembled || assembled.includes("__GEMINI")) return localStorage.getItem("gemini_key") || "";
            return assembled;
        };

        // INTELLIGENTE ANFRAGE MIT WARTEZEIT (RETRY LOGIC)
        const generateAI = async (prompt, systemPrompt, key, onStatus) => {
            if (!key) throw new Error("Kein API Key vorhanden.");

            const models = ['gemini-2.5-flash-preview-09-2025', 'gemini-1.5-flash'];
            const waitTime = 20000; // 20 Sekunden warten bei Fehler

            const callApi = async (model) => {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: systemPrompt }] }, { role: "user", parts: [{ text: prompt }] }] })
                });
                
                if (res.status === 429) throw new Error("LIMIT");
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            };

            // 1. Versuch: Bestes Modell (2.5)
            try {
                if (onStatus) onStatus("Denke nach (Modell: High-End)...");
                return await callApi(models[0]);
            } catch (e) {
                if (e.message === "LIMIT") {
                    // WARTEN statt abbrechen
                    if (onStatus) onStatus("Hohe Auslastung. Warte 20s auf Premium-Slot...");
                    await new Promise(r => setTimeout(r, waitTime));
                    
                    // 2. Versuch: Bestes Modell (2.5) nach Wartezeit
                    try {
                        if (onStatus) onStatus("Versuche es erneut (High-End)...");
                        return await callApi(models[0]);
                    } catch (e2) {
                        if (e2.message === "LIMIT") {
                             // Letzte Chance: Warten noch einmal
                             if (onStatus) onStatus("Immer noch voll. Ein letzter Versuch...");
                             await new Promise(r => setTimeout(r, waitTime));
                             try {
                                 return await callApi(models[0]);
                             } catch(e3) {
                                 // Fallback auf 1.5 wenn es gar nicht geht
                                 if (onStatus) onStatus("Wechsle zu Standard-Modell (schneller)...");
                                 return await callApi(models[1]);
                             }
                        }
                        throw e2;
                    }
                }
                throw e;
            }
        };

        const searchImage = async (query) => {
            const clean = query.replace(/bild von|foto von/gi, '').trim();
            try {
                const url = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrnamespace=6&gsrsearch=${encodeURIComponent(clean)}&gsrlimit=1&prop=imageinfo&iiprop=url&format=json&origin=*`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.query?.pages) return Object.values(data.query.pages)[0].imageinfo[0].url;
            } catch (e) {}
            return `https://image.pollinations.ai/prompt/${encodeURIComponent(clean)}?width=800&height=600&nologo=true`;
        };

        // --- COMPONENTS ---

        const Home = ({ onNavigate, hasKey, setKey }) => {
            const [showKeyInput, setShowKeyInput] = useState(false);
            const [tempKey, setTempKey] = useState("");

            const saveKey = () => {
                localStorage.setItem("gemini_key", tempKey);
                setKey(tempKey);
                setShowKeyInput(false);
            };

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-slate-900 via-[#020617] to-indigo-950">
                    <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2 drop-shadow-lg">SchulSim AI</h1>
                    <p className="text-slate-400 font-bold tracking-widest text-xs uppercase mb-12">Version 8.0 ‚Ä¢ High Performance Priority</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
                        <button onClick={() => onNavigate('learn')} className="glass-panel p-8 rounded-2xl hover:bg-slate-800 transition-all group border-t-4 border-blue-500 text-left">
                            <div className="bg-blue-500/20 p-4 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform"><Icon path={ICONS.Brain} className="text-blue-400" size={32}/></div>
                            <h3 className="text-2xl font-bold mb-2 text-white">Verstehen</h3>
                            <p className="text-slate-400 text-sm">Erkl√§rungen & Fragen</p>
                        </button>

                        <button onClick={() => onNavigate('plan')} className="glass-panel p-8 rounded-2xl hover:bg-slate-800 transition-all group border-t-4 border-emerald-500 text-left">
                            <div className="bg-emerald-500/20 p-4 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform"><Icon path={ICONS.Calendar} className="text-emerald-400" size={32}/></div>
                            <h3 className="text-2xl font-bold mb-2 text-white">Lernplan</h3>
                            <p className="text-slate-400 text-sm">Ziele erreichen</p>
                        </button>

                        <button onClick={() => onNavigate('pres')} className="glass-panel p-8 rounded-2xl hover:bg-slate-800 transition-all group border-t-4 border-orange-500 text-left">
                            <div className="bg-orange-500/20 p-4 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform"><Icon path={ICONS.Presentation} className="text-orange-400" size={32}/></div>
                            <h3 className="text-2xl font-bold mb-2 text-white">Referat</h3>
                            <p className="text-slate-400 text-sm">Folien & Skript</p>
                        </button>
                    </div>

                    <div className="mt-12">
                        <button onClick={() => setShowKeyInput(true)} className={`text-xs px-4 py-2 rounded-full border flex items-center gap-2 ${hasKey ? 'border-green-500 text-green-400' : 'border-red-500 text-red-400 animate-pulse'}`}>
                            <Icon path={ICONS.Key} size={14}/> {hasKey ? "System Bereit" : "API Key fehlt"}
                        </button>
                    </div>

                    {showKeyInput && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="text-white font-bold mb-4">API Key eingeben</h3>
                                <input className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white mb-4 outline-none focus:border-blue-500" placeholder="AIzaSy..." value={val} onChange={e => setTempKey(e.target.value)} />
                                <div className="flex gap-2">
                                    <button onClick={saveKey} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Speichern</button>
                                    <button onClick={() => setShowKeyInput(false)} className="px-4 py-2 text-slate-400">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ... LearnModule and PresModule definitions remain similar but use new generateAI ...

        // 3. PLAN MODULE (VISUAL & DOWNLOAD)
        const PlanModule = ({ apiKey, onBack }) => {
            const [goal, setGoal] = useState("");
            const [date, setDate] = useState("");
            const [plan, setPlan] = useState(null);
            const [loading, setLoading] = useState(false);
            const [statusText, setStatusText] = useState("");

            const createPlan = async () => {
                if(!goal || !date || !apiKey) return;
                setLoading(true);
                try {
                    const prompt = `Erstelle einen detaillierten Lernplan. Ziel: "${goal}". Bis: "${date}". 
                    WICHTIG: Antworte NUR mit einem JSON Array. Format: [{"day":"Montag 12.10.","task":"Kapitel 1 lesen","type":"Theorie","duration":"45min"}, ...].`;
                    
                    const res = await generateAI(prompt, "Du bist ein Planer. Antworte NUR mit JSON.", apiKey, setStatusText);
                    const json = res.replace(/```json|```/g, '').trim();
                    setPlan(JSON.parse(json));
                } catch(e) { alert("Fehler: " + e.message); }
                setLoading(false);
            };

            const downloadImage = () => {
                if(!plan) return;
                const element = document.getElementById('plan-content');
                html2canvas(element, {backgroundColor: "#0f172a"}).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Lernplan_${goal.replace(/ /g,'_')}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            return (
                <div className="h-full flex flex-col bg-slate-950">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#0b0f19]">
                        <h2 className="font-bold text-emerald-400 flex gap-2"><Icon path={ICONS.Calendar}/> Lernplan</h2>
                        <button onClick={onBack}><Icon path={ICONS.Back}/></button>
                    </div>
                    
                    {loading ? (
                         <div className="flex-1 flex flex-col items-center justify-center p-8 relative overflow-hidden">
                             <div className="absolute inset-0 bg-blue-900/10 animate-pulse"></div>
                             <Icon path={ICONS.Calendar} size={64} className="text-emerald-500 mb-6 animate-bounce"/>
                             <h3 className="text-2xl font-bold text-white mb-2">Erstelle Plan...</h3>
                             <p className="text-emerald-400 font-mono text-sm">{statusText || "Analysiere Zeitraum..."}</p>
                             <div className="w-64 h-1 bg-slate-800 rounded-full mt-8 overflow-hidden relative"><div className="absolute top-0 left-0 h-full bg-emerald-500 w-1/2 animate-scan"></div></div>
                         </div>
                    ) : !plan ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 gap-6 animate-enter">
                            <h3 className="text-3xl font-bold text-white text-center">Dein Weg zum Ziel</h3>
                            <div className="w-full max-w-md space-y-4">
                                <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-emerald-500" placeholder="Lernziel (z.B. Alle L√§nder Europas)" value={goal} onChange={e=>setGoal(e.target.value)} />
                                <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-emerald-500" placeholder="Bis wann? (z.B. Freitag)" value={date} onChange={e=>setDate(e.target.value)} />
                                <button onClick={createPlan} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-xl font-bold shadow-lg transition-all">Plan erstellen</button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col overflow-hidden bg-[#0f172a]" id="plan-export-area">
                            <div className="p-4 flex justify-end bg-[#1e293b] border-b border-white/10">
                                <button onClick={downloadImage} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><Icon path={ICONS.Download} size={16}/> Als Bild speichern</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-8" id="plan-content">
                                <div className="max-w-4xl mx-auto">
                                    <div className="text-center mb-10">
                                        <h2 className="text-4xl font-black text-white mb-2">{goal}</h2>
                                        <p className="text-emerald-400 font-bold uppercase tracking-widest">Deadline: {date}</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {plan.map((item, i) => (
                                            <div key={i} className="bg-slate-800 p-6 rounded-2xl border border-white/5 shadow-xl">
                                                <div className="flex justify-between items-center mb-4">
                                                    <span className="font-bold text-emerald-400 bg-emerald-900/30 px-3 py-1 rounded-full text-sm">{item.day}</span>
                                                    <span className="text-xs text-slate-500">{item.duration}</span>
                                                </div>
                                                <h4 className="text-white font-bold text-lg mb-2">{item.type}</h4>
                                                <p className="text-slate-300 text-sm leading-relaxed">{item.task}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Note: PresModule and LearnModule are simplified here to fit the main changes but follow the same logic as before.
        // Full integration below.

        const PresModule = ({ apiKey, onBack }) => {
            const [topic, setTopic] = useState("");
            const [slides, setSlides] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("");
            const [idx, setIdx] = useState(0);
            
            const create = async () => {
                if(!topic) return;
                setLoading(true);
                try {
                    setStatus("Analysiere Thema...");
                    // Artificial delay removed, waiting for API response takes time anyway
                    const sys = `Erstelle JSON f√ºr Pr√§sentation (5 Folien). Thema: ${topic}. Format: [{"title":"...","content":["..."],"imageQuery":"...","flashcard":"..."}]. Layouts: image_right. Nur JSON.`;
                    
                    const res = await generateAI(`Erstelle Pr√§sentation`, sys, apiKey, setStatus);
                    const json = res.replace(/```json|```/g, '').trim();
                    const parsed = JSON.parse(json);
                    setSlides(parsed);
                    
                    for(let i=0; i<parsed.length; i++) {
                        if(parsed[i].imageQuery) {
                            setStatus(`Suche Bild f√ºr Folie ${i+1}...`);
                            parsed[i].imageUrl = await searchImage(parsed[i].imageQuery);
                        }
                    }
                    setSlides([...parsed]);
                } catch(e) { alert("Fehler: " + e.message); }
                setLoading(false);
            };
            
            const download = () => {
                const pptx = new window.PptxGenJS();
                slides.forEach(s => {
                    const slide = pptx.addSlide();
                    slide.addText(s.title, { x:0.5, y:0.5, fontSize:24, bold:true });
                    slide.addText(s.content, { x:0.5, y:1.5, fontSize:14, bullet:true });
                    if(s.imageUrl) slide.addImage({ path:s.imageUrl, x:6, y:1.5, w:3.5, h:3 });
                    slide.addNotes(s.flashcard);
                });
                pptx.writeFile({ fileName: 'Praesentation.pptx' });
            };

            return (
                <div className="h-full flex flex-col bg-slate-950 relative">
                    {loading && (
                        <div className="absolute inset-0 z-50 bg-slate-950/95 backdrop-blur-xl flex flex-col items-center justify-center">
                            <Icon path={ICONS.Presentation} size={80} className="text-orange-500 animate-pulse mb-6" />
                            <h2 className="text-3xl font-black text-white mb-2">Erstelle Pr√§sentation</h2>
                            <p className="text-orange-400 font-mono text-sm animate-pulse">{status}</p>
                        </div>
                    )}
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#0b0f19]">
                        <h2 className="font-bold text-orange-400 flex gap-2"><Icon path={ICONS.Presentation}/> Studio</h2>
                        <button onClick={onBack}><Icon path={ICONS.Back}/></button>
                    </div>
                    {slides.length === 0 ? (
                         <div className="flex-1 flex flex-col items-center justify-center p-8 gap-6 animate-enter">
                             <h3 className="text-3xl font-bold text-white">Referat erstellen</h3>
                             <div className="w-full max-w-md space-y-4">
                                <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-orange-500" placeholder="Thema..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                <button onClick={create} className="w-full bg-orange-600 hover:bg-orange-500 text-white p-4 rounded-xl font-bold shadow-lg transition-all flex justify-center items-center gap-2">Generieren</button>
                             </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                            <div className="flex-1 p-8 bg-slate-900 flex flex-col items-center justify-center">
                                <div className="aspect-video bg-white text-black w-full max-w-3xl rounded-xl shadow-2xl p-8 flex flex-col relative">
                                    <h2 className="text-3xl font-bold mb-4 border-b-2 border-orange-500 pb-2">{slides[idx].title}</h2>
                                    <div className="flex-1 flex gap-4">
                                        <div className="flex-1 text-lg"><ul>{slides[idx].content.map((t,i)=><li key={i} className="mb-2">‚Ä¢ {t}</li>)}</ul></div>
                                        {slides[idx].imageUrl && <img src={slides[idx].imageUrl} className="w-1/3 object-contain rounded" />}
                                    </div>
                                </div>
                                <div className="flex gap-4 mt-6">
                                    <button onClick={()=>setIdx(Math.max(0, idx-1))} className="p-3 bg-slate-800 rounded-full hover:bg-slate-700"><Icon path={ICONS.Back} className="rotate-90"/></button>
                                    <button onClick={()=>setIdx(Math.min(slides.length-1, idx+1))} className="p-3 bg-slate-800 rounded-full hover:bg-slate-700"><Icon path={ICONS.Send}/></button>
                                    <button onClick={download} className="px-6 py-3 bg-orange-600 rounded-full font-bold">PPTX</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const LearnModule = ({ apiKey, onBack }) => {
            const [chat, setChat] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [file, setFile] = useState(null);
            
            const chatEnd = useRef(null);
            useEffect(() => chatEnd.current?.scrollIntoView({ behavior: 'smooth' }), [chat, loading]);
            
            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) { const r = new FileReader(); r.onload=ev=>setFile(ev.target.result); r.readAsDataURL(f); }
            };

            const send = async () => {
                if (!input.trim() && !file) return;
                const userMsg = { role: 'user', text: input, img: file };
                setChat(prev => [...prev, userMsg]);
                setInput(""); setFile(null); setLoading(true);
                try {
                    const text = await generateAI(userMsg.text, "Du bist ein Tutor.", apiKey, null, userMsg.img?.split(',')[1]);
                    let img = null;
                    if (userMsg.text.length < 50 && !userMsg.img) img = await searchImage(userMsg.text); 
                    setChat(prev => [...prev, { role: 'model', text, img }]);
                } catch (e) { setChat(prev => [...prev, { role: 'model', text: "Fehler: " + e.message }]); }
                setLoading(false);
            };

            return (
                 <div className="h-full flex flex-col bg-slate-950">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#0b0f19]">
                        <h2 className="font-bold text-blue-400 flex gap-2"><Icon path={ICONS.Brain}/> Lernen</h2>
                        <button onClick={onBack}><Icon path={ICONS.Back}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {chat.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role === 'user' ? 'items-end' : 'items-start'}`}>
                                {m.img && <img src={m.img} className="mb-2 w-48 rounded-lg" />}
                                <div className={`max-w-[85%] p-4 rounded-xl ${m.role === 'user' ? 'bg-blue-600' : 'bg-slate-800'}`}>{m.text}</div>
                            </div>
                        ))}
                        {loading && <div className="text-slate-500 text-xs animate-pulse">KI schreibt...</div>}
                        <div ref={chatEnd}></div>
                    </div>
                    <div className="p-4 bg-[#0b0f19] border-t border-white/10 flex gap-2">
                        <label className="p-2 bg-slate-800 rounded-lg cursor-pointer"><Icon path={ICONS.Image}/><input type="file" className="hidden" onChange={handleFile}/></label>
                        <input className="flex-1 bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white" placeholder="Nachricht..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} />
                        <button onClick={()=>send()} className="p-2 bg-blue-600 rounded-lg text-white"><Icon path={ICONS.Send}/></button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [key, setKey] = useState(getKey());
            const [currentModule, setCurrentModule] = useState(null);
            useEffect(() => { const k = getKey(); if (k) setKey(k); }, []);
            
            if (currentModule === 'learn') return <LearnModule apiKey={key} onBack={() => setCurrentModule(null)} />;
            if (currentModule === 'plan') return <PlanModule apiKey={key} onBack={() => setCurrentModule(null)} />;
            if (currentModule === 'pres') return <PresModule apiKey={key} onBack={() => setCurrentModule(null)} />;
            
            return <Home onNavigate={setCurrentModule} hasKey={!!key} setKey={setKey} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
